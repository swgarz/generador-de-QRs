<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generador de C√≥digos QR (Gratis, Local)</title>
  <meta name="description" content="Genera c√≥digos QR de URLs sin servidores ni pagos. Descarga PNG o SVG. 100% local en tu navegador, con fallback si el CDN est√° bloqueado." />
  <style>
    :root{--bg:#0b0c10;--card:#16181d;--text:#e6e6e6;--muted:#a7a7a7;--accent:#59d0ff;--accent-2:#79ffa6}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:linear-gradient(180deg,#0b0c10,#13151a 40%,#0b0c10);color:var(--text);}
    .wrap{max-width:1440px;margin:0 auto;padding:28px}
    /* Header centrado y moderno */
    header{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;margin-bottom:20px;text-align:center}
    h1{font-size:clamp(1.6rem,1.2rem+3vw,2.6rem);margin:0;line-height:1.15;background:linear-gradient(90deg,#e6e6e6,#79ffa6 40%,#59d0ff);-webkit-background-clip:text;background-clip:text;color:transparent}
    .lead{max-width:980px;color:var(--muted);font-size:1.05rem;line-height:1.5;text-align:justify;text-justify:inter-word;margin:0 auto}
    .lead.center-last{text-align-last:center}

    .card{background:var(--card);border:1px solid #22252b;border-radius:18px;box-shadow:0 8px 30px rgba(0,0,0,.25);padding:18px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:1000px){.grid{grid-template-columns:2fr 1fr}}

    label{display:block;font-size:1rem;color:var(--muted);margin-bottom:8px}
    input[type="text"],input[type="url"],input[type="number"],input[type="search"],select,textarea{
      width:100%;padding:14px 16px;border-radius:14px;border:1px solid #30343b;background:#0f1116;color:var(--text);font-size:18px;transition:border-color .15s ease, box-shadow .15s ease
    }
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 4px rgba(89,208,255,.15)}

    /* URL MUCHO M√ÅS GRANDE */
    #url{font-size:24px;padding:18px 20px;height:68px;border-radius:16px}

    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    .col-12{grid-column:span 12}

    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px}
    button,a.button{appearance:none;border:none;background:var(--accent);color:#061218;font-weight:700;border-radius:14px;padding:12px 16px;cursor:pointer;transition:transform .06s ease,filter .2s ease,text-shadow .15s;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    button.secondary,a.button.secondary{background:#30343b;color:var(--text)}
    button:hover,a.button:hover{filter:brightness(1.05)}
    button:active{transform:translateY(1px)}

    .muted{color:var(--muted);font-size:.95rem}
    .qr-box{display:flex;flex-direction:column;align-items:center;justify-content:center;background:#0e1116;border:1px dashed #2a2e36;border-radius:14px;min-height:380px;padding:12px}
    .qr-caption{margin-top:12px;color:var(--muted);font-size:.85rem;text-align:center;max-width:90%;font-style:italic}

    .outputs{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .hr{height:1px;background:#23262d;margin:12px 0}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:.9rem}
    .success{color:var(--accent-2);font-weight:600}
    .error{color:#ff7b7b;font-weight:600}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.9em; padding:2px 6px; border:1px solid #30343b; border-radius:6px;}
    details.tests{margin-top:12px}
    details.tests summary{cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Generador de C√≥digos QR ‚Äî Gratis y Local</h1>
      <p class="lead center-last">Funciona en tu navegador. Sin cuentas ni pagos. Si el CDN est√° bloqueado, entra en modo servicio para que puedas seguir generando y <strong>descargando</strong> tus QRs en PNG y SVG.</p>
    </header>

    <div class="grid">
      <!-- Panel Izquierdo: Controles -->
      <section class="card">
        <div class="row" style="align-items:end">
          <div class="col-12">
            <label for="url">URL <span class="muted">(pega aqu√≠ la direcci√≥n que quieres codificar)</span></label>
            <input id="url" type="url" placeholder="https://tu-dominio.com/mi-pagina" autocomplete="on" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="col-12">
            <label for="caption">Descripci√≥n (opcional) <span class="muted">(aparecer√° debajo del QR y tambi√©n dentro de la imagen descargada)</span></label>
            <input id="caption" type="text" placeholder="Ej.: Men√∫ digital ‚Äî Sucursal Roma" maxlength="140" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="col-4">
            <label for="size">Tama√±o (px)</label>
            <input id="size" type="number" min="120" max="2048" step="10" value="320" />
          </div>
          <div class="col-4">
            <label for="margin">Margen (m√≥dulos)</label>
            <input id="margin" type="number" min="0" max="12" step="1" value="4" />
          </div>
          <div class="col-4">
            <label for="ecc">Correcci√≥n de errores</label>
            <select id="ecc">
              <option value="L">L (baja, mayor capacidad)</option>
              <option value="M" selected>M (equilibrado)</option>
              <option value="Q">Q (alta)</option>
              <option value="H">H (m√°xima)</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="col-6">
            <label for="filename">Nombre de archivo (sin extensi√≥n)</label>
            <input id="filename" type="text" placeholder="mi_qr" />
          </div>
          <div class="col-6">
            <label>&nbsp;</label>
            <div class="actions">
              <button id="generate">Generar QR</button>
              <button id="clear" class="secondary" type="button">Limpiar</button>
            </div>
          </div>
        </div>

        <div class="outputs">
          <div class="hr"></div>
          <div class="actions">
            <a id="downloadPng" class="button" download="qr.png" href="#" aria-disabled="true">Descargar PNG</a>
            <a id="downloadSvg" class="button secondary" download="qr.svg" href="#" aria-disabled="true">Descargar SVG</a>
          </div>
          <div id="status" class="muted"></div>
          <div class="muted">Consejo: para impresi√≥n n√≠tida, descarga <span class="kbd">SVG</span>.</div>
        </div>

        <details class="tests">
          <summary>üß™ Ver resultados de pruebas autom√°ticas</summary>
          <div id="testLog" class="muted" style="margin-top:8px"></div>
        </details>
      </section>

      <!-- Panel Derecho: Vista Previa -->
      <section class="card">
        <div class="qr-box" id="qrBox">
          <div class="muted">Tu QR aparecer√° aqu√≠</div>
        </div>
      </section>
    </div>

    <footer>
      Hecho con <span aria-hidden>‚ù§Ô∏è</span> y <span class="kbd">QRCode</span> JS ‚Äî Todo local (con fallback a servicio gratuito si hace falta).
    </footer>
  </div>

  <!-- Cargador robusto de la librer√≠a QRCode con fallback a MODO SERVICIO si el CDN est√° bloqueado -->
  <script>
    const QR_LIB_URLS = [
      'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js',
      'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js'
    ];
    let qrLibLoaded = false;
    let USE_SERVICE_MODE = false; // Fallback si no se puede cargar la librer√≠a

    function ensureQRCodeReady(){
      return new Promise((resolve) => {
        if (window.QRCode && typeof window.QRCode.toCanvas === 'function') {
          qrLibLoaded = true; return resolve('lib');
        }
        const tryIndex = (i) => {
          if (window.QRCode && typeof window.QRCode.toCanvas === 'function') { qrLibLoaded = true; return resolve('lib'); }
          if (i >= QR_LIB_URLS.length) {
            USE_SERVICE_MODE = true; qrLibLoaded = false; return resolve('service');
          }
          const s = document.createElement('script');
          s.src = QR_LIB_URLS[i];
          s.async = true;
          s.onload = () => {
            if (window.QRCode && typeof window.QRCode.toCanvas === 'function') { qrLibLoaded = true; resolve('lib'); }
            else tryLoadNext();
          };
          s.onerror = () => tryLoadNext();
          function tryLoadNext(){ tryIndex(i+1); }
          document.body.appendChild(s);
        };
        tryIndex(0);
      });
    }
  </script>

  <!-- App -->
  <script>
    // Utilidades
    const $ = (sel) => document.querySelector(sel);
    const byId = (id) => document.getElementById(id);

    // Sanitiza nombres de archivo
    function safeFileName(name, fallback = "qr") {
      const s = (name || "").trim().toLowerCase().replace(/\s+/g, "_");
      return s.replace(/[^a-z0-9_\-\.]/g, "") || fallback;
    }

    // --- Helpers de descarga "siempre funciona" ---
    function revokeOldObjectUrl(anchor){
      try {
        const a = typeof anchor === 'string' ? byId(anchor) : anchor;
        if (a && a.dataset && a.dataset.objectUrl) {
          URL.revokeObjectURL(a.dataset.objectUrl);
          delete a.dataset.objectUrl;
        }
      } catch {}
    }

    function setAnchorDownloadFromBlob(anchorId, blob, filename){
      const a = byId(anchorId);
      if (!a) return;
      revokeOldObjectUrl(a);
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.dataset.objectUrl = url;
      a.download = filename;
      a.setAttribute('aria-disabled','false');
    }

    function setAnchorDirectUrl(anchorId, url, filename){
      const a = byId(anchorId);
      if (!a) return;
      revokeOldObjectUrl(a);
      a.href = url;
      a.download = filename;
      a.setAttribute('aria-disabled','false');
    }

    function dataURLToBlob(dataURL){
      const parts = dataURL.split(',');
      const mime = parts[0].match(/:(.*?);/)[1];
      const bstr = atob(parts[1]);
      let n = bstr.length; const u8arr = new Uint8Array(n);
      while(n--) u8arr[n] = bstr.charCodeAt(n);
      return new Blob([u8arr], {type:mime});
    }

    // Renderiza/actualiza la descripci√≥n bajo el QR (vista previa)
    function renderCaption(text){
      const box = byId('qrBox');
      let cap = byId('qrCaption');
      if (!cap) {
        cap = document.createElement('div');
        cap.id = 'qrCaption';
        cap.className = 'qr-caption';
        box.appendChild(cap);
      }
      cap.textContent = text || '';
      cap.style.display = text ? 'block' : 'none';
    }

    // ------ COMPOSICI√ìN: Incluir descripci√≥n dentro de PNG/SVG descargados ------
    let __lastComposedSvgText = "";
    let __lastPngComposedWithCaption = false;

    function wrapTextCanvas(ctx, text, maxWidth, font){
      if (!text) return [];
      ctx.save();
      if (font) ctx.font = font;
      const words = text.split(/\s+/);
      const lines = [];
      let line = '';
      for (const w of words){
        const test = line ? line + ' ' + w : w;
        const wpx = ctx.measureText(test).width;
        if (wpx > maxWidth && line) { lines.push(line); line = w; }
        else line = test;
      }
      if (line) lines.push(line);
      ctx.restore();
      return lines;
    }

    function composeCanvasWithCaption(qrCanvas, caption){
      const W = qrCanvas.width; const H = qrCanvas.height;
      const padTop = 12, padBottom = 16, sidePad = 8;
      const fontSize = Math.max(10, Math.round(W * 0.035));
      const lineHeight = Math.round(fontSize * 1.25);
      const temp = document.createElement('canvas');
      const tctx = temp.getContext('2d');
      tctx.font = `italic ${fontSize}px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif`;
      const lines = wrapTextCanvas(tctx, caption, W - 2*sidePad);
      const captionHeight = lines.length ? (padTop + lines.length*lineHeight + padBottom) : 0;
      const canvas = document.createElement('canvas');
      canvas.width = W; canvas.height = H + captionHeight;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(qrCanvas, 0, 0);
      if (lines.length){
        ctx.fillStyle = '#000000';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        ctx.font = `italic ${fontSize}px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif`;
        let y = H + padTop;
        for (const ln of lines){
          ctx.fillText(ln, W/2, y);
          y += lineHeight;
        }
        __lastPngComposedWithCaption = true;
      } else {
        __lastPngComposedWithCaption = false;
      }
      return canvas;
    }

    function wrapTextSimple(text, maxCharsPerLine){
      if (!text) return [];
      const words = text.split(/\s+/);
      const lines = [];
      let line = '';
      for (const w of words){
        const test = line ? line + ' ' + w : w;
        if (test.length > maxCharsPerLine && line){ lines.push(line); line = w; }
        else line = test;
      }
      if (line) lines.push(line);
      return lines;
    }

    function escapeXml(s){
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;');
    }

    function composeSvgWithCaption(svgString, caption, size){
      const W = size; const padTop = 12, padBottom = 16;
      const fontSize = Math.max(10, Math.round(W * 0.035));
      const approxChars = Math.max(10, Math.floor(W / (fontSize*0.6)));
      const lines = wrapTextSimple(caption, approxChars);
      const lineHeight = Math.round(fontSize * 1.25);
      const captionHeight = lines.length ? (padTop + lines.length*lineHeight + padBottom) : 0;
      const H = W + captionHeight;
      const inner = svgString.replace(/<svg(\s|>)/i, '<svg x="0" y="0" $1');
      const textBlocks = lines.map((ln, i)=>{
        const dy = i===0 ? 0 : lineHeight;
        return `<tspan x="${W/2}" dy="${dy}">${escapeXml(ln)}</tspan>`;
      }).join('');
      const composed = `<?xml version="1.0" encoding="UTF-8"?>\n<svg xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">\n  <rect width="${W}" height="${H}" fill="#ffffff"/>\n  <g>${inner}</g>\n  ${lines.length ? `<text x="${W/2}" y="${W + padTop}" font-family="system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif" font-size=\"${fontSize}\" font-style=\"italic\" text-anchor="middle" fill="#000000">${textBlocks}</text>` : ''}\n</svg>`;
      __lastComposedSvgText = composed;
      return composed;
    }

    // ‚úÖ Definici√≥n correcta de setStatus (arregla SyntaxError)
    function setStatus(msg, kind = "info") {
      const el = byId("status");
      el.textContent = msg || "";
      el.className = kind === "error" ? "error" : kind === "success" ? "success" : "muted";
    }

    function paramsFromURL() {
      const p = new URLSearchParams(location.search);
      return {
        data: p.get("data") || "",
        size: parseInt(p.get("size") || "320", 10),
        margin: parseInt(p.get("margin") || "4", 10),
        ecc: (p.get("ecc") || "M").toUpperCase(),
        filename: p.get("filename") || ""
      };
    }

    function populateFromParams() {
      const { data, size, margin, ecc, filename } = paramsFromURL();
      if (data) byId("url").value = decodeURIComponent(data);
      byId("size").value = Number.isFinite(size) ? size : 320;
      byId("margin").value = Number.isFinite(margin) ? margin : 4;
      byId("ecc").value = ["L","M","Q","H"].includes(ecc) ? ecc : "M";
      if (filename) byId("filename").value = safeFileName(filename);
      if (data) generateQR();
    }

    async function generateQR() {
      const data = byId("url").value.trim();
      if (!data) { setStatus("Ingresa una URL.", "error"); return; }
      const size = Math.max(120, Math.min(2048, parseInt(byId("size").value || "320", 10)));
      const margin = Math.max(0, Math.min(12, parseInt(byId("margin").value || "4", 10)));
      const ecc = byId("ecc").value || "M";
      const filename = safeFileName(byId("filename").value || "qr");
      const captionText = byId('caption').value.trim();

      const box = byId("qrBox");
      box.innerHTML = "";

      try {
        const mode = await ensureQRCodeReady();

        if (USE_SERVICE_MODE || mode === 'service') {
          const enc = encodeURIComponent(data);
          const base = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${enc}&margin=${margin}&ecc=${ecc}`;
          const pngUrl = base;

          await new Promise((resolve)=>{
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = async () => {
              try {
                const qrCanvas = document.createElement('canvas');
                qrCanvas.width = size; qrCanvas.height = size;
                const ictx = qrCanvas.getContext('2d');
                ictx.fillStyle = '#ffffff'; ictx.fillRect(0,0,size,size);
                ictx.drawImage(img, 0, 0, size, size);
                const composedPreview = captionText ? composeCanvasWithCaption(qrCanvas, captionText) : qrCanvas;
                box.appendChild(composedPreview);
                const composedBlob = await new Promise((resolve2, reject2)=> composedPreview.toBlob ? composedPreview.toBlob(b=> b?resolve2(b):reject2(new Error('No blob')), 'image/png') : resolve2(dataURLToBlob(composedPreview.toDataURL('image/png'))));
                setAnchorDownloadFromBlob('downloadPng', composedBlob, filename + '.png');
                const dataUrlPng = composedPreview.toDataURL('image/png');
                const svgWrapped = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"${composedPreview.width}\" height=\"${composedPreview.height}\" viewBox=\"0 0 ${composedPreview.width} ${composedPreview.height}\">
  <rect width=\"100%\" height=\"100%\" fill=\"#ffffff\"/>
  <image href=\"${dataUrlPng}\" x=\"0\" y=\"0\" width=\"${composedPreview.width}\" height=\"${composedPreview.height}\"/>
</svg>`;
                __lastComposedSvgText = svgWrapped;
                const svgBlob = new Blob([svgWrapped], {type:'image/svg+xml'});
                setAnchorDownloadFromBlob('downloadSvg', svgBlob, filename + '.svg');
                setStatus("QR generado correctamente (modo servicio).", "success");
              } catch (e) {
                box.innerHTML = '';
                const fallbackImg = new Image();
                fallbackImg.alt = 'Vista previa del QR';
                fallbackImg.src = pngUrl; box.appendChild(fallbackImg);
                setAnchorDirectUrl('downloadPng', pngUrl, filename + '.png');
                setAnchorDirectUrl('downloadSvg', base + '&format=svg', filename + '.svg');
                setStatus('Generado (modo servicio, sin composici√≥n por CORS)', 'info');
              }
              resolve();
            };
            img.onerror = () => {
              const fallbackImg = new Image();
              fallbackImg.alt = 'Vista previa del QR';
              fallbackImg.src = pngUrl; box.appendChild(fallbackImg);
              setAnchorDirectUrl('downloadPng', pngUrl, filename + '.png');
              setAnchorDirectUrl('downloadSvg', base + '&format=svg', filename + '.svg');
              setStatus('Generado (modo servicio, sin composici√≥n por error de carga)', 'info');
              resolve();
            };
            img.src = pngUrl;
          });
          return;
        }

        // --- Modo librer√≠a local ---
        const canvas = await new Promise((resolve, reject) => {
          window.QRCode.toCanvas(data, { width: size, margin, errorCorrectionLevel: ecc }, (err, c) => {
            if (err) reject(err); else resolve(c);
          });
        });
        const previewCanvas = captionText ? composeCanvasWithCaption(canvas, captionText) : canvas;
        box.appendChild(previewCanvas);

        const pngBlob = await new Promise((resolve, reject)=> {
          if (previewCanvas.toBlob) {
            previewCanvas.toBlob((b)=> b? resolve(b): reject(new Error('No se pudo crear blob PNG')), 'image/png');
          } else {
            try { const b = dataURLToBlob(previewCanvas.toDataURL('image/png')); resolve(b); } catch(err){ reject(err); }
          }
        });
        setAnchorDownloadFromBlob('downloadPng', pngBlob, filename + '.png');

        let svgString = await new Promise((resolve, reject) => {
          window.QRCode.toString(data, { type: "svg", width: size, margin, errorCorrectionLevel: ecc }, (err, str) => {
            if (err) reject(err); else resolve(str);
          });
        });
        if (captionText) svgString = composeSvgWithCaption(svgString, captionText, size);
        const svgBlob = new Blob([svgString], { type: "image/svg+xml" });
        setAnchorDownloadFromBlob('downloadSvg', svgBlob, filename + '.svg');

        setStatus("QR generado correctamente.", "success");
      } catch (e) {
        console.error(e);
        setStatus("Ocurri√≥ un error al generar el QR.", "error");
      }
    }

    function clearAll() {
      byId("url").value = "";
      byId("filename").value = "";
      byId("caption").value = "";
      setStatus("");
      byId("qrBox").innerHTML = '<div class="muted">Tu QR aparecer√° aqu√≠</div>';
      byId("downloadPng").href = "#";
      byId("downloadPng").setAttribute("aria-disabled", "true");
      byId("downloadSvg").href = "#";
      byId("downloadSvg").setAttribute("aria-disabled", "true");
    }

    // --- Pruebas autom√°ticas (test cases) ---
    async function runTests(){
      const logs = [];
      const ok = (m)=> logs.push('‚úÖ ' + m);
      const info = (m)=> logs.push('‚ÑπÔ∏è ' + m);
      const fail = (m)=> logs.push('‚ùå ' + m);
      try {
        const mode = await ensureQRCodeReady();
        const testUrl = 'https://example.com';
        byId('url').value = testUrl;
        byId('caption').value = 'Demo: descripci√≥n de prueba';
        await generateQR();

        const aPng = byId('downloadPng');
        const aSvg = byId('downloadSvg');
        if (aPng && aPng.getAttribute('aria-disabled')==='false' && aPng.href) ok('Bot√≥n PNG listo para descarga'); else fail('Bot√≥n PNG no listo');
        if (aSvg && aSvg.getAttribute('aria-disabled')==='false' && aSvg.href) ok('Bot√≥n SVG listo para descarga'); else fail('Bot√≥n SVG no listo');

        if (aPng.href.startsWith('blob:')) ok('PNG usa blob para descarga directa'); else info('PNG usa URL directa (fallback)');
        if (aSvg.href.startsWith('blob:')) ok('SVG usa blob para descarga directa'); else info('SVG usa URL directa (fallback)');

        // üîé Tests adicionales
        setStatus('prueba ok','success');
        if (byId('status').className.includes('success')) ok('setStatus aplica clase success'); else fail('setStatus no aplic√≥ success');
        const fn = safeFileName(' Mi Archivo: 2025/09*22 ');
        if (fn === 'mi_archivo_2025_09_22'.replace('__','_')) ok('safeFileName sanitiza'); else info('safeFileName resultado: '+fn);
        const capEl = byId('qrCaption');
        if (capEl && capEl.textContent.includes('Demo: descripci√≥n de prueba')) ok('Caption renderiza bajo el QR'); else fail('Caption no renderiz√≥');
        if (__lastComposedSvgText.includes('Demo: descripci√≥n de prueba')) ok('SVG incluye descripci√≥n'); else fail('SVG no incluye descripci√≥n');
        if (__lastPngComposedWithCaption) ok('PNG compuesto con descripci√≥n'); else info('PNG sin composici√≥n (sin caption o fallback)');
      } catch (e) {
        fail(e.message || String(e));
      }
      const logEl = byId('testLog');
      if (logEl) logEl.innerHTML = logs.map(l=>`<div>${l}</div>`).join('');
    }

    // Eventos
    window.addEventListener("load", async () => {
      try { await ensureQRCodeReady(); } catch {}
      populateFromParams();
      byId("generate").addEventListener("click", generateQR);
      byId("clear").addEventListener("click", clearAll);
      byId("url").addEventListener("keydown", (e) => { if (e.key === "Enter") generateQR(); });
      runTests();
    });
  </script>
</body>
</html>
